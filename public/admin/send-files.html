<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Files - Admin Panel</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../../favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../favicon/favicon-16x16.png">
    <link rel="manifest" href="../../favicon/site.webmanifest">
    <link rel="shortcut icon" href="../../favicon/favicon.ico">
    <link rel="icon" type="image/png" sizes="192x192" href="../../favicon/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../../favicon/android-chrome-512x512.png">
    <link rel="stylesheet" href="/admin/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        .file-preview {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .file-preview.active {
            display: block;
        }

        .file-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .file-icon {
            font-size: 48px;
            color: #351C42;
        }

        .file-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .upload-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }

        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #351C42;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="view">
            <header>
                <div class="header-brand">
                    <img src="/images/chkarunyatrustlogo.png" alt="Logo" class="dashboard-logo">
                    <h1>Send Files</h1>
                </div>
                <div class="header-right">
                    <button onclick="window.location.href='/admin'" class="nav-btn">‚Üê Back to Dashboard</button>
                    <button id="logout-btn">Logout</button>
                </div>
            </header>

            <main>
                <div class="toolbar">
                    <h2>Upload and Send Files</h2>
                    <p style="color: #666; margin: 5px 0 0 0;">Send images or PDF documents to patients via email</p>
                </div>

                <div class="file-send-container">
                    <!-- Upload Form -->
                    <div class="file-form-card">
                        <h3>üì§ New File Transfer</h3>
                        <form id="file-send-form">
                            <div class="form-group">
                                <label>Patient Name *</label>
                                <input type="text" id="patient-name" required placeholder="Enter patient name">
                            </div>

                            <div class="form-group">
                                <label>Phone Number *</label>
                                <input type="tel" id="patient-phone" required placeholder="+91 XXXXX XXXXX">
                            </div>

                            <div class="form-group">
                                <label>Email Address *</label>
                                <input type="email" id="patient-email" required placeholder="patient@example.com">
                            </div>

                            <div class="form-group">
                                <label>Select File (Image or PDF) *</label>
                                <input type="file" id="patient-file" accept="image/*,application/pdf" required>
                                <small style="color: #666; display: block; margin-top: 5px;">Supported: JPG, PNG,
                                    PDF</small>
                            </div>

                            <!-- File Preview -->
                            <div id="file-preview" class="file-preview">
                                <div id="preview-content"></div>
                                <div class="file-info">
                                    <strong>File:</strong> <span id="file-name"></span><br>
                                    <strong>Type:</strong> <span id="file-type"></span><br>
                                    <strong>Size:</strong> <span id="file-size"></span>
                                </div>
                            </div>

                            <!-- Upload Status -->
                            <div id="upload-status" class="upload-status"></div>

                            <button type="submit" class="primary-btn" style="width: 100%; margin-top: 20px;">
                                Send File
                            </button>
                        </form>
                    </div>

                    <!-- File Logs -->
                    <div class="file-logs-card">
                        <h3>üìã Recent Transfers</h3>
                        <table id="file-logs-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Patient</th>
                                    <th>File</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="file-logs-list">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: #999;">No transfers yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script type="module">
        import {
            logoutAdmin,
            monitorAuthState,
            uploadReportFile,
            createReportLog,
            getFileLogs
        } from '/js/firebase-service.js';

        // Initialize EmailJS (client-side only)
        if (typeof emailjs !== 'undefined') {
            try {
                emailjs.init("s-yzfkw_g8ZBWm5WJ");
            } catch (e) {
                console.error("EmailJS Init Error:", e);
            }
        }

        // Auth check
        monitorAuthState((user) => {
            if (!user) {
                window.location.href = '/admin';
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await logoutAdmin();
            window.location.href = '/admin';
        });

        // Toast notification
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // File preview
        const fileInput = document.getElementById('patient-file');
        const filePreview = document.getElementById('file-preview');
        const previewContent = document.getElementById('preview-content');
        const fileName = document.getElementById('file-name');
        const fileType = document.getElementById('file-type');
        const fileSize = document.getElementById('file-size');

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                filePreview.classList.remove('active');
                return;
            }

            fileName.textContent = file.name;
            fileType.textContent = file.type.includes('pdf') ? 'PDF Document' : 'Image';
            fileSize.textContent = (file.size / 1024).toFixed(2) + ' KB';

            if (file.type.includes('image')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewContent.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    filePreview.classList.add('active');
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                previewContent.innerHTML = '<div class="file-icon">üìÑ</div>';
                filePreview.classList.add('active');
            }
        });

        // Form submission
        const fileForm = document.getElementById('file-send-form');
        const uploadStatus = document.getElementById('upload-status');

        fileForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = fileForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Uploading...';
            submitBtn.disabled = true;

            const patientName = document.getElementById('patient-name').value;
            const phoneNumber = document.getElementById('patient-phone').value;
            const email = document.getElementById('patient-email').value;
            const file = fileInput.files[0];

            if (!file) {
                uploadStatus.className = 'upload-status error';
                uploadStatus.textContent = 'Please select a file';
                uploadStatus.style.display = 'block';
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return;
            }

            try {
                // Upload to Cloudinary
                uploadStatus.className = 'upload-status';
                uploadStatus.textContent = 'Uploading file to cloud...';
                uploadStatus.style.display = 'block';

                const { url, format } = await uploadReportFile(file);

                // Send email
                uploadStatus.textContent = 'Sending email...';

                const templateParams = {
                    file_url: url,
                    to_email: email,
                    patient_email: email,
                    to_name: patientName,
                    patient_name: patientName,
                    name: patientName,
                    link: url,
                    url: url,
                    download_link: url,
                    file_link: url,
                    message: `Your file is ready for download: ${url}`,
                    reply_to: 'admin@karunyacharitabletrust.org',
                    from_name: 'Karunya Trust'
                };

                if (typeof emailjs === 'undefined') {
                    throw new Error('EmailJS is not loaded. Please refresh the page.');
                }
                await emailjs.send("service_kihk1eo", "template_e1ugog3", templateParams);

                // Log to Firestore
                try {
                    await createReportLog({
                        patientName,
                        phoneNumber,
                        patientEmail: email,
                        fileUrl: url,
                        fileType: format,
                        status: 'success'
                    });
                } catch (dbError) {
                    console.error("Firestore Error:", dbError);
                }

                // Success
                uploadStatus.className = 'upload-status success';
                uploadStatus.textContent = '‚úì File sent successfully!';
                showToast('File sent to ' + email, 'success');

                // Reset form
                fileForm.reset();
                filePreview.classList.remove('active');
                fetchFileLogs();

                setTimeout(() => {
                    uploadStatus.style.display = 'none';
                }, 5000);

            } catch (error) {
                console.error(error);
                uploadStatus.className = 'upload-status error';
                uploadStatus.textContent = '‚úó Error: ' + error.message;

                try {
                    await createReportLog({
                        patientEmail: email,
                        fileUrl: '',
                        fileType: 'unknown',
                        status: 'failed'
                    });
                } catch (e) {
                    console.error("Failed to log error", e);
                }
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Fetch file logs
        async function fetchFileLogs() {
            try {
                const logs = await getFileLogs();
                const fileLogsList = document.getElementById('file-logs-list');

                if (logs.length === 0) {
                    fileLogsList.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No transfers yet</td></tr>';
                    return;
                }

                fileLogsList.innerHTML = logs.map(log => `
                    <tr>
                        <td>${new Date(log.sentAt || log.createdAt).toLocaleDateString()}</td>
                        <td>${log.patientName || log.patientEmail}</td>
                        <td><a href="${log.fileUrl || log.filePath}" target="_blank" style="color: #351C42; font-weight: 600;">View File</a></td>
                        <td><span style="color: ${log.status === 'success' ? 'green' : 'red'};">${log.status}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error fetching logs', error);
            }
        }

        // Load logs on page load
        fetchFileLogs();
    </script>
</body>

</html>